<!DOCTYPE html>
<html>

<head>
  <base target="_top" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous" />

  <link rel="icon" type="image/png"
    href="https://github.com/drusho/workout-app/blob/main/images/barbell.png?raw=true" />
  <style>
    body {
      padding: 15px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .btn {
      margin-top: 15px;
    }

    #status {
      margin-top: 15px;
      font-weight: bold;
    }

    #workoutDisplay {
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    #workoutDisplay h5 {
      margin-top: 0;
    }

    #workoutDisplay ul {
      padding-left: 20px;
      margin-bottom: 0;
    }

    #workoutDisplay li {
      margin-bottom: 5px;
    }

    #loadingIndicator {
      display: none;
      color: #888;
      margin-left: 5px;
    }
  </style>
</head>

<body>
  <h4>Workout Logger</h4>

  <div class="form-group">
    <label for="workoutLetter">Select Workout to View & Log</label>
    <select class="form-control" id="workoutLetter" name="workoutLetter" required onchange="loadAndDisplayWorkout()">
      <option value="" disabled selected>Select workout...</option>
      <option value="A">Workout A</option>
      <option value="B">Workout B</option>
      <option value="C">Workout C</option>
    </select>
    <span id="loadingIndicator">Loading...</span>
  </div>

  <div id="workoutDisplay">
    <h5>Selected Workout Details:</h5>
    <div id="workoutDetailsList">
      <p><i>Select a workout letter above to see details.</i></p>
    </div>
  </div>

  <hr />
  <h5>Log Completed Exercise</h5>
  <form id="logForm">
    <div class="form-group">
      <label for="exerciseName">Exercise</label>
      <select class="form-control" id="exerciseName" name="exerciseName" required disabled
        onchange="prefillFormFields()">
        <option value="" disabled selected>
          Select workout letter first...
        </option>
      </select>
    </div>

    <div class="form-group">
      <label for="setsPerformed">Sets Performed</label>
      <select class="form-control" id="setsPerformed" name="setsPerformed" required>
        <option value="" disabled selected>Select sets...</option>

      </select>
    </div>

    <div class="form-group">
      <label for="repsPerformed">Reps Performed (Target/Last Set)</label>
      <select class="form-control" id="repsPerformed" name="repsPerformed" required>
        <option value="" disabled selected>Select reps...</option>

      </select>
    </div>

    <div class="form-group">
      <label for="weightUsed">Weight Used (lbs)</label>
      <input type="number" step="any" class="form-control" id="weightUsed" name="weightUsed" required />
    </div>

    <div class="form-group">
      <label for="rpe">RPE (Reps Per Exertion) (0-10)</label>
      <select class="form-control" id="rpe" name="rpe" required>
        <option value="" disabled selected>Select RPE...</option>

      </select>
    </div>

    <button type="submit" class="btn btn-primary">Log Exercise</button>
  </form>
  <hr />
  <div id="sessionLogDisplay">
    <h5>Session Log:</h5>
    <ul id="sessionLogList">
      <li><i>No exercises logged yet in this session.</i></li>
    </ul>
  </div>

  <div id="status"></div>

  <script>
    const workoutLetterSelect = document.getElementById("workoutLetter");
    const exerciseSelect = document.getElementById("exerciseName");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const statusDiv = document.getElementById("status");
    const logForm = document.getElementById("logForm");
    const workoutDetailsListDiv =
      document.getElementById("workoutDetailsList");
    const appState = {
      currentWorkoutDetails: [],
      sessionLog: []
    };

    function clearFormFields() {
      console.log("clearFormFields called"); // Added log for confirmation
      document.getElementById("setsPerformed").value = "";
      document.getElementById("repsPerformed").value = "";
      document.getElementById("weightUsed").value = "";
      document.getElementById("rpe").value = ""; // Also clear RPE
    }

    function updateSessionLogDisplay() {
      console.log("updateSessionLogDisplay called"); // Added log for confirmation
      const listElement = document.getElementById("sessionLogList"); // Ensure your <ul> has id="sessionLogList"
      listElement.innerHTML = ""; // Clear existing list

      if (appState.sessionLog.length === 0) {
        // Create a placeholder item if the log is empty
        const placeholderItem = document.createElement("li");
        placeholderItem.innerHTML =
          "<i>No exercises logged yet in this session.</i>";
        listElement.appendChild(placeholderItem);
      } else {
        appState.sessionLog.forEach((item) => {
          const listItem = document.createElement("li");
          // Basic escaping for display (ensure item properties exist)
          let name = item.name || "[No Name]";
          let sets = item.sets !== undefined ? item.sets : "-";
          let reps = item.reps !== undefined ? item.reps : "-";
          let weight = item.weight !== undefined ? item.weight : "-";
          let rpe = item.rpe !== undefined ? item.rpe : "-";

          let escapedName = name
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
          listItem.textContent = `${escapedName}: ${sets} sets x ${reps} reps @ ${weight} lbs, RPE ${rpe}`;
          listElement.appendChild(listItem);
        });
      }
    }

    function prefillFormFields() {
      console.log("prefillFormFields called."); // Keep console logs for debugging
      const selectedExerciseName = exerciseSelect.value; // exerciseSelect should be defined globally

      // Get the input fields
      const setsInput = document.getElementById('setsPerformed');
      const repsInput = document.getElementById('repsPerformed');
      const weightInput = document.getElementById('weightUsed');

      // Clear existing values and placeholder
      setsInput.value = '';
      repsInput.value = '';
      weightInput.value = '';
      repsInput.placeholder = ''; // Clear placeholder

      if (selectedExerciseName && appState.currentWorkoutDetails.length > 0) {
        // Find the data for the selected exercise
        const exerciseData = appState.currentWorkoutDetails.find(ex => ex.name === selectedExerciseName);

        if (exerciseData) {
          console.log("prefillFormFields: Found data for", selectedExerciseName, exerciseData);
          // Prefill Sets and Weight
          setsInput.value = exerciseData.sets || '';
          weightInput.value = exerciseData.weight || '';

          // Handle Reps, specifically checking for "AMRAP"
          if (exerciseData.reps && typeof exerciseData.reps === 'string' && exerciseData.reps.toUpperCase() === 'AMRAP') {
            repsInput.value = ''; // Leave numeric input blank for AMRAP
            repsInput.placeholder = 'AMRAP'; // Set placeholder text
            console.log("prefillFormFields: Setting reps placeholder to AMRAP.");
          } else {
            repsInput.value = exerciseData.reps || ''; // Prefill numeric reps
            repsInput.placeholder = ''; // Ensure placeholder is clear
            console.log("prefillFormFields: Setting reps value to", exerciseData.reps);
          }
        } else {
          console.log("prefillFormFields: No data found for", selectedExerciseName);
        }
      } else {
        console.log("prefillFormFields: No exercise selected or no workout details loaded.");
      }
    }

    function toggleLoading(isLoading) {
      loadingIndicator.style.display = isLoading ? "inline" : "none";
      logForm.querySelectorAll("input, select, button").forEach(el => {
        el.disabled = isLoading;
      });
    }

    function loadAndDisplayWorkout() {
      console.log("loadAndDisplayWorkout: Function started."); // <<< ADD
      const selectedLetter = workoutLetterSelect.value;

      // Clear previous state and show loading
      console.log("loadAndDisplayWorkout: Clearing previous state."); // <<< ADD
      exerciseSelect.innerHTML =
        '<option value="" disabled selected>Loading...</option>';
      exerciseSelect.disabled = true;
      workoutDetailsListDiv.innerHTML = "<p><i>Loading details...</i></p>";
      loadingIndicator.style.display = "inline";
      statusDiv.textContent = "";
      clearFormFields();
      appState.sessionLog = [];
      updateSessionLogDisplay();

      if (!selectedLetter) {
        console.log("loadAndDisplayWorkout: No letter selected, exiting."); // <<< ADD
        exerciseSelect.innerHTML =
          '<option value="" disabled selected>Select workout letter first...</option>';
        workoutDetailsListDiv.innerHTML =
          "<p><i>Select a workout letter above to see details.</i></p>";
        loadingIndicator.style.display = "none";
        return;
      }

      console.log(
        "loadAndDisplayWorkout: Calling server function getWorkoutDetails for letter: " +
        selectedLetter
      ); // <<< ADD
      // Call server-side function to get details
      google.script.run
        .withSuccessHandler(handleWorkoutDataSuccess)
        .withFailureHandler(handleLoadFailure)
        .getWorkoutDetails(selectedLetter);
      console.log("loadAndDisplayWorkout: Server call initiated."); // <<< ADD
    }

    // Populate display AND dropdown on successful fetch
    function handleWorkoutDataSuccess(workoutData) {
      console.log("handleWorkoutDataSuccess: Function started."); // <<< ADD
      console.log("handleWorkoutDataSuccess: Received data:", workoutData); // <<< ADD VIEW RECEIVED DATA

      // workoutData is expected to be an array of objects:
      // [{ name: "Ex1", sets: 2, reps: 5, weight: 100 }, { ... }]
      appState.currentWorkoutDetails = []; // Reset
      exerciseSelect.innerHTML = "";
      workoutDetailsListDiv.innerHTML = "";

      if (
        workoutData &&
        Array.isArray(workoutData) &&
        workoutData.length > 0
      ) {
        // <<< Added Array.isArray check
        console.log(
          "handleWorkoutDataSuccess: Data received is valid array."
        ); // <<< ADD
        appState.currentWorkoutDetails = workoutData; // Store the fetched data

        exerciseSelect.add(new Option("Select exercise...", "", true, true));
        let displayHtml = "<ul>";
        workoutData.forEach((exercise) => {
          // Basic safety check for properties
          let name = exercise.name || "[No Name]";
          let sets = exercise.sets !== undefined ? exercise.sets : "-";
          let reps = exercise.reps !== undefined ? exercise.reps : "-";
          let weight = exercise.weight !== undefined ? exercise.weight : "-";

          let escapedName = name
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
          exerciseSelect.add(new Option(escapedName, escapedName));
          displayHtml += `<li>${escapedName}: ${sets} sets x ${reps} reps @ ${weight} lbs</li>`;
        });
        displayHtml += "</ul>";
        workoutDetailsListDiv.innerHTML = displayHtml;
        exerciseSelect.disabled = false;
        console.log(
          "handleWorkoutDataSuccess: Populated display and dropdown."
        ); // <<< ADD
      } else {
        console.warn(
          "handleWorkoutDataSuccess: Received no data or invalid data format."
        ); // <<< ADD Warning
        exerciseSelect.innerHTML =
          '<option value="" disabled selected>No exercises found</option>';
        workoutDetailsListDiv.innerHTML =
          "<p><i>No exercises found for this workout letter.</i></p>";
      }
      loadingIndicator.style.display = "none";
      console.log("handleWorkoutDataSuccess: Function finished."); // <<< ADD
    }

    // Handle failure during loading
    function handleLoadFailure(error) {
      console.error("handleLoadFailure: Function started."); // <<< ADD Error log
      console.error("handleLoadFailure: Received error:", error); // <<< ADD VIEW ERROR OBJECT
      exerciseSelect.innerHTML =
        '<option value="" disabled selected>Error loading</option>';
      workoutDetailsListDiv.innerHTML = `<p><i>Error loading workout details. Check console (F12).</i></p>`; // Update message
      loadingIndicator.style.display = "none";
      statusDiv.textContent = "Error loading workout data: " + error.message;
      console.error("handleLoadFailure: Function finished."); // <<< ADD
    }

    // Function to handle form submission (remains the same)
    function handleFormSubmit(event) {
      console.log("handleFormSubmit: Function Started!");
      event.preventDefault();
      statusDiv.textContent = "Submitting...";

      const formData = {
        workoutLetter: workoutLetterSelect.value,
        exerciseName: exerciseSelect.value,
        setsPerformed: document.getElementById("setsPerformed").value,
        repsPerformed: document.getElementById("repsPerformed").value,
        weightUsed: document.getElementById("weightUsed").value,
        rpe: document.getElementById("rpe").value,
      };
      console.log("handleFormSubmit: Calling google.script.run.processLogForm with data:", formData);
      google.script.run
        .withSuccessHandler(handleSubmitSuccess)
        .withFailureHandler(handleSubmitFailure)
        .processLogForm(formData);

      console.log("handleFormSubmit: google.script.run call initiated.");
    }

    // Success handler needs to potentially refresh the displayed workout
    // if progression changed the values for the currently selected workout
    function handleSubmitSuccess(result) {
      console.log("handleSubmitSuccess: Function started."); // <<< ADD
      console.log(
        "handleSubmitSuccess: Received result from server:",
        result
      );
      // Use result.message to display the success text
      if (result && result.message) {
        statusDiv.textContent = result.message;
      } else {
        console.warn(
          "handleSubmitSuccess: Received result object did not contain expected message property."
        );
        statusDiv.textContent = "Exercise logged (message unclear).";
      }

      // Add logged data to our session log array using result.loggedData
      if (result && result.loggedData) {
        console.log(
          "handleSubmitSuccess: Found loggedData, attempting to push:",
          result.loggedData
        );
        appState.sessionLog.push(result.loggedData);
        console.log(
          "handleSubmitSuccess: sessionLog content after push:",
          appState.sessionLog
        );
        // *** THIS CALL IS CORRECT ***
        updateSessionLogDisplay(); // Update the session log display on the page
      } else {
        console.warn(
          "handleSubmitSuccess: result.loggedData was missing or undefined in server response."
        );
      }

      logForm.reset(); // Reset form fields

      // Reload workout data to show potential progression updates in display/prefill
      if (workoutLetterSelect.value) {
        console.log(
          "handleSubmitSuccess: Updating workout data display is needed here IF progression happened."
        ); // Placeholder comment
        // loadAndDisplayWorkout(); // <<< COMMENT OUT OR REMOVE THIS LINE! It reloads everything and clears session log.
      } else {
        exerciseSelect.innerHTML =
          '<option value="" disabled selected>Select workout letter first...</option>';
        exerciseSelect.disabled = true;
      }

      setTimeout(() => {
        statusDiv.textContent = "";
      }, 5000); // Clear status later
      console.log("handleSubmitSuccess: Function finished."); // <<< ADD
    }

    // Failure handler remains similar
    function handleSubmitFailure(error) {
      console.error("handleSubmitFailure: Function started."); // <<< ADD
      console.error("handleSubmitFailure: Received error:", error);
      statusDiv.textContent = "Error: " + error.message;
    }

    // Add form submit listener
    logForm.addEventListener("submit", handleFormSubmit);
    console.log(
      "Script execution reached end. Attempting to attach listener."
    );

    if (logForm) {
      // Check if the form element was actually found
      console.log("Attaching submit listener to logForm..."); // <<< ADD
      logForm.addEventListener("submit", handleFormSubmit);
      console.log("Submit listener attached to logForm."); // <<< ADD
    } else {
      console.error(
        "CRITICAL: Could not find element with id='logForm'. Submit listener NOT attached."
      ); // <<< ADD Error log
    }

    /**
     * Populates the dropdown with options from 0 to the specified range.
     * @param {string} id - The ID of the dropdown element.
     * @param {number} range - The maximum value for the dropdown options.
     */
    function populateDropdown(id, range) {
      const dropdown = document.getElementById(id);
      for (let i = 0; i <= range; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        dropdown.appendChild(option);
      }
    }

    // Populate dropdowns on page load
    document.addEventListener("DOMContentLoaded", () => {
      populateDropdown("setsPerformed", 5);
      populateDropdown("repsPerformed", 25);
      populateDropdown("rpe", 10);
    });
  </script>
</body>

</html>